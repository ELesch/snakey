// Prisma 7 Schema - Snakey Reptile Care Tracker

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Reptile {
  id              String    @id @default(cuid())
  userId          String
  name            String
  species         String
  morph           String?
  sex             Sex       @default(UNKNOWN)
  birthDate       DateTime?
  acquisitionDate DateTime
  currentWeight   Decimal?
  notes           String?
  isPublic        Boolean   @default(false)
  shareId         String?   @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  deletedAt       DateTime?

  // Relations
  feedings        Feeding[]
  sheds           Shed[]
  weights         Weight[]
  environmentLogs EnvironmentLog[]
  vetVisits       VetVisit[]
  medications     Medication[]
  photos          Photo[]
  expenses        Expense[]

  // Breeding relations
  pairingsAsMale   Pairing[] @relation("MaleParent")
  pairingsAsFemale Pairing[] @relation("FemaleParent")

  @@index([userId])
  @@index([species])
  @@index([shareId])
}

enum Sex {
  MALE
  FEMALE
  UNKNOWN
}

// ============================================================================
// CARE TRACKING
// ============================================================================

model Feeding {
  id           String     @id @default(cuid())
  reptileId    String
  date         DateTime
  preyType     String
  preySize     String
  preySource   PreySource
  accepted     Boolean
  refused      Boolean    @default(false)
  regurgitated Boolean    @default(false)
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  reptile Reptile @relation(fields: [reptileId], references: [id])

  @@index([reptileId, date])
}

enum PreySource {
  LIVE
  FROZEN_THAWED
  PRE_KILLED
}

model Shed {
  id            String      @id @default(cuid())
  reptileId     String
  startDate     DateTime?
  completedDate DateTime
  quality       ShedQuality
  isComplete    Boolean     @default(true)
  issues        String?
  notes         String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  reptile Reptile @relation(fields: [reptileId], references: [id])
  photos  Photo[] @relation("ShedPhotos")

  @@index([reptileId, completedDate])
}

enum ShedQuality {
  COMPLETE
  PARTIAL
  PROBLEMATIC
}

model Weight {
  id        String   @id @default(cuid())
  reptileId String
  date      DateTime
  weight    Decimal
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reptile Reptile @relation(fields: [reptileId], references: [id])

  @@index([reptileId, date])
}

model EnvironmentLog {
  id          String   @id @default(cuid())
  reptileId   String
  date        DateTime
  temperature Decimal?
  humidity    Decimal?
  location    String?
  notes       String?
  isAlert     Boolean  @default(false)
  createdAt   DateTime @default(now())

  reptile Reptile @relation(fields: [reptileId], references: [id])

  @@index([reptileId, date])
}

// ============================================================================
// VETERINARY CARE
// ============================================================================

model VetVisit {
  id        String    @id @default(cuid())
  reptileId String
  date      DateTime
  reason    String
  diagnosis String?
  treatment String?
  vetName   String?
  vetClinic String?
  cost      Decimal?
  followUp  DateTime?
  notes     String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  reptile   Reptile @relation(fields: [reptileId], references: [id])
  documents Photo[] @relation("VetDocuments")

  @@index([reptileId, date])
}

model Medication {
  id        String    @id @default(cuid())
  reptileId String
  name      String
  dosage    String
  frequency String
  startDate DateTime
  endDate   DateTime?
  notes     String?
  reminders Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  reptile Reptile @relation(fields: [reptileId], references: [id])

  @@index([reptileId])
}

// ============================================================================
// PHOTOS
// ============================================================================

model Photo {
  id            String        @id @default(cuid())
  reptileId     String
  storagePath   String
  thumbnailPath String?
  caption       String?
  takenAt       DateTime      @default(now())
  category      PhotoCategory @default(GENERAL)
  createdAt     DateTime      @default(now())

  reptile    Reptile   @relation(fields: [reptileId], references: [id])
  shed       Shed?     @relation("ShedPhotos", fields: [shedId], references: [id])
  shedId     String?
  vetVisit   VetVisit? @relation("VetDocuments", fields: [vetVisitId], references: [id])
  vetVisitId String?

  @@index([reptileId, takenAt])
}

enum PhotoCategory {
  GENERAL
  MORPH
  SHED
  VET
  ENCLOSURE
}

// ============================================================================
// BREEDING
// ============================================================================

model Pairing {
  id         String    @id @default(cuid())
  userId     String
  maleId     String
  femaleId   String
  startDate  DateTime
  endDate    DateTime?
  successful Boolean?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  male     Reptile  @relation("MaleParent", fields: [maleId], references: [id])
  female   Reptile  @relation("FemaleParent", fields: [femaleId], references: [id])
  clutches Clutch[]

  @@index([userId])
}

model Clutch {
  id             String    @id @default(cuid())
  pairingId      String
  layDate        DateTime
  eggCount       Int
  fertileCount   Int?
  incubationTemp Decimal?
  dueDate        DateTime?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  pairing    Pairing     @relation(fields: [pairingId], references: [id])
  hatchlings Hatchling[]

  @@index([pairingId])
}

model Hatchling {
  id        String      @id @default(cuid())
  clutchId  String
  hatchDate DateTime?
  status    HatchStatus
  morph     String?
  sex       Sex         @default(UNKNOWN)
  notes     String?
  reptileId String?
  createdAt DateTime    @default(now())

  clutch Clutch @relation(fields: [clutchId], references: [id])

  @@index([clutchId])
}

enum HatchStatus {
  DEVELOPING
  HATCHED
  FAILED
  SOLD
  KEPT
}

// ============================================================================
// EXPENSES
// ============================================================================

model Expense {
  id          String          @id @default(cuid())
  reptileId   String?
  userId      String
  date        DateTime
  category    ExpenseCategory
  amount      Decimal
  description String
  vendor      String?
  createdAt   DateTime        @default(now())

  reptile Reptile? @relation(fields: [reptileId], references: [id])

  @@index([userId, date])
}

enum ExpenseCategory {
  FOOD
  VET
  SUPPLIES
  ENCLOSURE
  OTHER
}

// ============================================================================
// SPECIES CONFIGURATION
// ============================================================================

model SpeciesConfig {
  id              String   @id @default(cuid())
  species         String   @unique
  commonName      String
  tempHotMin      Decimal
  tempHotMax      Decimal
  tempCoolMin     Decimal
  tempCoolMax     Decimal
  humidityMin     Decimal
  humidityMax     Decimal
  feedingInterval Int
  notes           String?
  isBuiltIn       Boolean  @default(true)
  userId          String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

// ============================================================================
// SYNC QUEUE (for offline support)
// ============================================================================

model SyncQueue {
  id         String     @id @default(cuid())
  userId     String
  operation  String
  tableName  String
  recordId   String
  payload    Json
  status     SyncStatus @default(PENDING)
  retryCount Int        @default(0)
  error      String?
  createdAt  DateTime   @default(now())
  syncedAt   DateTime?

  @@index([userId, status])
}

enum SyncStatus {
  PENDING
  SYNCING
  SYNCED
  FAILED
}
